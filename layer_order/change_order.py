from qgis.core import QgsProject, QgsVectorLayer, QgsLayerTreeNode, QgsMapLayer, QgsProviderRegistry
from qgis.gui import QgsLayerTreeView
from qgis.utils import iface
import os
from .layers_order import layers_order

#layers_order = [['winter_resourts', 'Комплекси зимових видів спорту'], ['water_transport', "Об'єкти водного транспорту"], ['urban_space_types', 'Характерні типи міських просторів'], ['unesco_nature_p', "Природні об'єкти всесвітньої спадщини ЮНЕСКО"], ['tunnel_objects_p', 'Локалізація тунелів'], ['trollyebus_service', "Об'єкти обслуговування тролейбусних ліній"], ['transport_enterprises', 'Транспортні підприємства'], ['techservice_stations', 'Станції технічного обслуговування'], ['str_hydro_p', 'Гідроінженерні споруди'], ['storage_objects', "Складські об'єкти"], ['sport_fishery_objects', "Об'єкти любительського і спортивного рибальства"], ['sewerage_objects', "Об'єктинa каналізаційних мережах"], ['sew_treat_plants', 'Каналізаційні очисні споруди'], ['runway_service', "Об'єкти обслуговування злітно-посадкових смуг"], ['review_point', 'Оглядові точки'], ['resort_objects', 'Санаторно-курортні та оздоровчі заклади'], ['recultivation_allocation', 'Місця рекультивації порушених територій'], ['railways_obj', "Об'єктинa залізничних мережах"], ['rail_transport', "Об'єкти залізничних перевезень"], ['public_transport_stops', 'Зупинки громадського транспорту'], ['public_toilets', 'Громадські туалети'], ['product_pipes_objects', "Об'єктинa продуктопроводах"], ['potent_hazard_objects', "Потенційно небезпечні об'єкти (ПНО)"], ['pollution_objects', 'Основні забруднювачі'], ['plant_cultivation_objects', 'Підприємства рослинництва'], ['planning_centres', 'Планувальні центри'], ['petrol_stations', 'Автозаправочні станції'], ['objects_banks', 'Фінансові установи'], ['natural_hazards_points', 'Локалізація небезпечних природних процесів'], ['named_ob', "Поіменовані адресні об'єкти"], ['meteostations', 'Основні метеостанції державної мережі спостережень'], ['main_water_objects', "Об'єктинa магістральних водопроводах"], ['logistic_centres', 'Логістичні центри'], ['local_water_objects', "Об'єкти місцевих водопровідних мереж питного водопостачання"], ['local_techwater_objects', "Об'єкти місцевих водопровідних мереж технічного водопостачання"], ['livestock_objects', 'Підприємства тваринництва'], ['hunting_objects', "Мисливські об'єкти"], ['hotels', 'Заклади короткострокового проживання'], ['high_hazard_objects', "Об'єкти підвищенної небезпеки (ОПН)"], ['heritage_monuments', "Пам'ятки культурної спадщини"], ['heating_objects', "Об'єктинa мережах теплопостачання"], ['garages', 'Гаражі'], ['forestery_objects', "Лісогоподарські об'єкти"], ['fishery_objects', 'Рибницькі підприємства'], ['fire_wat_intake_place_p', 'Розміщення облаштованих місць забору води для потреб пожежогасіння'], ['fire_reservoirs_p', 'Розміщення водойм для гасіння пожеж (штучні)'], ['evacuation_points', 'Пункти евакуації'], ['evac_pop_distrib_points', 'Пункти розміщення евакуйованого/ відселеного населення'], ['env_protect_meas_p', 'Локалізація проведення заходів з охорони довкілля'], ['env_monitoring_p', 'Пункти моніторингу стану довкілля'], ['env_conflict_res_p', 'Вузли вирішення можливих конфліктів господарської діяльності та збереження довкілля'], ['eng_protect_other_p', 'Інші проектні заходи з інженерної підготовки та захисту території'], ['eng_protect_measures_p', 'Локалізація заходів із захисту території від небезпечних природних процесів'], ['dominant_build', 'Містобудівні домінанти (визначні споруди)'], ['disharmony', 'Дисгармонійні (дисонуючі) будівлі та споруди'], ['crematoria', 'Крематорії'], ['compos_nodes', 'Планувально-композиційні вузли'], ['communication_objects', "Об'єкти зв'язкунa трубопроводах"], ['civil_protect_constr_p', 'Розташування захисних споруд цивільного захисту'], ['chem_hazad_point_objects', "Хімічно небезпечні об'єкти з точковим джерелом забруднення"], ['auto_transport', "Об'єкти автотранспортних перевезень"], ['address', 'Адреси'], ['ammunition_stores', 'Склади військового озброєння (засобів ураження)'], ['animal_burial_grounds', 'Місця захоронення трупів тварин'], ['animal_shelters', 'Притулки для тварин'], ['beach_objects', 'Пляжі'], ['cemeteries', 'Кладовища'], ['avia_transport', "Об'єкти повітряних перевезень"], ['car_park', 'Автостоянки для постійного зберігання автомобілів'], ['bridge_objects_p', 'Локалізація мостових переходів та шляхопроводів'], ['autoservices', 'Пункти сервісунa автошляхах (комплекси автосервісу)'], ['civil_protect_objects_p', "Розташування об'єктів, що належать до категорій з цивільного захисту"], ['crossborder', 'Пункти пропуску через державний кордон'], ['garbage_grounds', 'Місця видалення відходів'], ['gas_pipes_objects', "Об'єктинa газопроводах"], ['geodetic_points', 'Геодезичні пункти'], ['green_p', "Об'єкти озеленення"], ['transport_storage', 'Транспортно-складські комплекси'], ['telecom_objects', "Телекомунікаційні об'єкти"], ['ritual_services', 'Організації з надання ритуальних послуг'], ['reserves_stores', 'Бази та склади матеріально-технічних, продовольчих та інших резервів'], ['recycling_object', 'Підприємства поводження з відходами'], ['rain_sewer_objects', "Об'єкти дощової каналізації"], ['pzf_p', "Об'єкти природно-заповідного фонду"], ['power_objects', "Об'єкти систем електрозабезпечення"], ['objects_catering', 'Заклади громадського харчування'], ['np_in_catastr_flood_areas', 'Населені пункти в зоні можливого катастрофічного затоплення у разі руйнування гребель'], ['minerals_p', 'Родовища корисних копалин'], ['lost_objects', "Значні втрачені об'єкти"], ['industry_objects', 'Промислові підприємства'], ['housing_offices', 'Житлово-експлуатаційні організації'], ['trucks_grounds', 'Майданчики для відстою вантажного автотранспорту'], ['terminals', 'Термінали'], ['ref_point', 'Опорні точки'], ['power_plants', 'Електростанції'], ['objects_research', 'Науково-дослідні, проектні та вишукувальні заклади'], ['objects_culture', "Об'єкти культури та мистецтва"], ['injured_med_help_points', 'Пункти надання необхідної медичної допомоги постраждалим'], ['innovative_objects', "Інноваційно-виробничі об'єкти"], ['interchange', "Транспортна розв'язка"], ['intern_wetlands_p', 'Водно-болотні угіддя, що мають міжнародне значення'], ['objects_education', 'Освітні заклади'], ['objects_home_service', 'Заклади побутового обслуговування'], ['objects_medical', "Заклади охорони здоров'я"], ['objects_monuments', 'Монументи, скульптури'], ['objects_pharmacy', 'Фармацевтичні заклади'], ['objects_public', 'Адміністративно-управлінські заклади'], ['objects_religious', "Культові об'єкти"], ['objects_social_protect', 'Заклади соціального захисту населення'], ['objects_sport', "Спортивні об'єкти"], ['objects_trade', 'Заклади торгівлі'], ['objects_veterinary', 'Ветеринарні лікарні'], ['oil_pipes_objects', "Об'єктинa нафтопроводах"], ['other_agro_objects', "Інші сільськогосподарські об'єкти"], ['vert_pl_slopes', 'Ухили вертикального планування'], ['local_power_lines', 'Лінії місцевих електромереж'], ['main_power_lines', 'Магістральні лінії електропередачі'], ['local_gas_pipes', 'Розподільні газопроводи'], ['main_gas_pipes', 'Магістральні газопроводи'], ['local_telecom_lines', 'Лінії місцевих телекомунікаційних мереж'], ['main_telecom_lines', 'Магістральні телекомунікаційні лінії'], ['water_supply', 'Місцеві водопроводи питного водопостачання'], ['water_tech_supply', 'Місцеві водопроводи технічного водопостачання'], ['main_water_pipes', 'Магістральні водопроводи'], ['rain_water_sewer', 'Трубопроводи дощової каналізації'], ['heating_pipes', 'Місцеві мережі теплопостачання'], ['main_oil_pipes', 'Магістральні нафтопроводи'], ['main_products_pipes', 'Продуктопроводи'], ['main_melioration_nets', 'Канали магістральних меліоративних систем'], ['forest_roads', 'Польові та лісові дороги'], ['spec_roads', 'Спеціалізовані дороги та проїзди'], ['bridge_objects_l', "Об'єкти мостових переходів та шляхопроводів"], ['roads', 'Автомобільні дороги'], ['trails', 'Мережа доріжок'], ['streets', 'Вулиці та дороги населених пунктів'], ['trolleybus_lines', 'Тролейбусні лінії'], ['transport_corridors', 'Транспортні коридори'], ['railways_local', 'Залізниці місцеві'], ['railways_main', 'Залізниці магістральні'], ['evacuation_paths', 'Маршрути евакуації населення'], ['public_transport_routes', 'Маршрути громадського транспорту'], ['tunnel_objects_l', "Об'єкти тунелів"], ['thresholds', "Характерні відстані (якісні пороги) видового розкриття пам'яток архітектури"], ['str_hydro_l', 'Гідроінженерні споруди'], ['sewerage', 'Трубопроводи каналізаційних мереж'], ['river', 'Водотоки'], ['review_axes', 'Оглядові осі'], ['planning_forms', 'Планувальні утворення в населених пунктах'], ['env_protect_meas_l', 'Лінії проведення заходів з охорони довкілля'], ['eng_protect_measures_l', 'Лінійна локалізація заходів із захисту території від небезпечних природних процесів'], ['compos_axes', 'Планувально-композиційні осі'], ['chemical_hazad_line_objects', "Хімічно небезпечні об'єкти лінійної протяжності"], ['roundabout_paths', 'Напрямки обходів у випадку руйнування основних шляхопроводів'], ['tour_routes', 'Туристичні маршрути'], ['review_fronts', 'Оглядові фронти'], ['planning_axes', 'Планувальні вісі'], ['countur', 'Горизонталі'], ['eng_protect_other_l', 'Інші проектні заходи з інженерної підготовки та захисту території'], ['protect_zones', 'Охоронні зони'], ['sanit_protect_zones', 'Санітарно-захисні зони'], ['sanit_gaps', "Санітарні відстані (розриви) від об'єкту"], ['areas_in_red_lines', 'Території в червоних лініях'], ['building_reg_lines', 'Території в лініях регулювання забудови'], ['areas_in_blue_lines', 'Території в блакитних лініях'], ['areas_in_green_lines', 'Території в зелених лініях'], ['areas_in_yellow_lines_pg', 'Території в жовтих лініях'], ['world_heritage_buf', "Буферні зони об'єктів всесвітньої спадщини"], ['waterprotect_zones', 'Водоохоронні зони'], ['pzf_protected_zones', "Охоронні зони об'єктів природно-заповідного фонду"], ['str_engineering', 'Будівлі та споруди інженерного забезпечення'], ['str_grounds', 'Функціональні майданчики'], ['str_hydro_pg', 'Гідроінженерні споруди'], ['str_industrial', 'Виробничі будівлі та споруди'], ['str_other', 'Інші будівлі та споруди'], ['str_public', 'Громадські будівлі та споруди'], ['str_residential', 'Житлові будівлі'], ['str_restrict', 'Спеціалізовані споруди'], ['str_transport', 'Будівлі та споруди транспорту'], ['dpt_area', 'Територія,нa яку розроблено ДПТ'], ['agro_landscape_groups', 'Агроландшафтні групи земель'], ['agro_soil', 'Агровиробничі групи ґрунтів'], ['ammunition_stores_impact_zones', 'Зона можливого ураження у випадку надзвичайної ситуаціїнa складах боєприпасів'], ['archeolog_protect_ter', 'Охоронювані археологічні території'], ['avia_limits', 'Авіаційні, радіолокаційні обмеження'], ['bank_protect', 'Прибережні захисні смуги'], ['beach_zones', 'Пляжні зони'], ['canals_bands', 'Смуги відведення гідротехнічних споруд'], ['catastrophic_flood_areas', 'Зони можливого катастрофічного затоплення у разі руйнування гребель'], ['chem_point_obj_pollut_hazad_areas', 'Зона можливого хімічного забруднення від точкового ХНО'], ['chemical_line_hazad_areas', 'Зона можливого хімічного забруднення від ХНО лінійної протяжності'], ['city_district', 'Райони у містах'], ['civil_protect_constr_pg', 'Захисні споруди цивільного захисту'], ['civil_protect_objects_pg', "Об'єкти, що належать до категорій з цивільного захисту"], ['climate', 'Поширення кліматичних показників'], ['degraded_soils', 'Ареали поширення деградованих та еродованих ґрунтів'], ['disturbed_areas', 'Порушені території'], ['econet', 'Структурні елементи екологічної мережі'], ['ecovillage', 'Території екопоселень'], ['education_zones', 'Зони обслуговування освітніми закладами'], ['emerald_network', 'Території Смарагдової мережі'], ['eng_protect_measures_pg', 'Ареали реалізації заходів із захисту території від небезпечних природних процесів'], ['eng_protect_other_pg', 'Інші проектні заходи з інженерної підготовки та захисту території'], ['env_aim', 'Оцінювання пріоритетності використання та охорони довкілля'], ['env_conflict_res_pg', 'Зони вирішення можливих конфліктів господарської діяльності та збереження довкілля'], ['env_monitoring_pg', 'Ареали моніторингу стану довкілля'], ['env_protect_meas_pg', 'Території проведення заходів з охорони довкілля'], ['evac_pop_distrib_areas', 'Території розміщення населення, евакуйованого із зони можливих сильних руйнувань'], ['expropriat_areas', "території, до складу яких входять земельні ділянки, необхідні для розміщення об'єктів, щодо яких відповідно до закону може здійснюватися примусове відчуження земельних ділянок з мотивів суспільної необхідності"], ['fire_reservoirs_pg', 'Водойми для гасіння пожеж (штучні)'], ['fire_stations', 'Пожежно-рятувальні підрозділи'], ['fire_wat_intake_place_pg', 'Облаштовані місця забору води для потреб пожежогасіння'], ['forest_belts', 'Лісосмуги'], ['free_econom_zones', 'Вільні економічні зони'], ['function_zoning_in', 'Функціональне використання територій існуюче'], ['function_zoning_pr', 'Функціональне призначення територій проектне'], ['green_pg', 'Озеленення'], ['hazard_radioact_pollut', 'Зони можливого небезпечного радіоактивного забруднення'], ['health_protect_zones', 'Зони санітарної охорони курортів'], ['heritage_mon_areas', "Визначні місця - пам'ятки культурної спадщини"], ['heritage_protect_zones', "Зони охорони пам'яток культурної спадщини"], ['high_hazard_obj_impact_zone', 'Зона впливу ОПН'], ['hist_cult_area', 'Історико-культурні заповідні території'], ['hist_cult_conserv', 'Історико-культурні заповідники'], ['historic_areals', 'Історичні ареали населених місць'], ['historic_build', 'Історична забудова'], ['historic_rajon', 'Історичні райони населеного пункту'], ['hromada', 'Території територіальних громад'], ['intern_wetlands_pg', 'Території водно-болотних угідь, що мають міжнародне значення'], ['invest_areas', 'Інвестиційно привабливі території'], ['land_conservation', 'Консервація земель'], ['landmanagement', 'Землевпорядні заходи'], ['lands', 'Контури земель'], ['lands_massif', 'Масив земель сільськогосподарського призначення'], ['landscape_assesm', 'Оцінювання ландшафтних умов'], ['landuse', 'Угіддя'], ['landuse_violation', 'Території порушення складу угідь'], ['loess_sediments_pg', 'Розповсюдження лесових порід, що мають властивість до просідання'], ['medical_zones', "Зони обслуговування закладами охорони здоров'я"], ['melioration', 'Території меліорації'], ['minerals_pg', 'Території залягання корисних копалин'], ['mining_allocation', 'Гірничі відводи'], ['mining_spec_permit', 'Спеціальні дозволинa користування надрами'], ['monuments_view_areas', "Зони огляду пам'яток архітектури"], ['natural_hazards_areas', 'Ареали поширення небезпечних природних процесів'], ['nuclear_pollut_zones', 'Зона можливого небезпечного радіоактивного забруднення від АЕС'], ['nuclear_power_plant_control_zones', 'Зони контролю АЕС'], ['parcel', 'Земельна ділянка'], ['pollution_areas', 'Зони забруднення компонентів довкілля'], ['potent_hazard_obj_impact_zone', 'Зона впливу ПНО'], ['pzf_pg', "Території та об'єкти природно-заповідного фонду"], ['pzf_reserve', 'Території, зарезервовані з метою наступного заповідання'], ['pzf_zon', "Зонування територій та об'єктів природно-заповідного фонду"], ['radiactive_limits', 'Радіаційні обмеження'], ['radionuclide_hazard', 'Зони наднормативних рівнів іонізуючих випромінювань природних радіонуклідів у приміщеннях будівель'], ['recultivation', 'Рекультивація порушених територій'], ['resid_build_shelter_areas', 'Території потенційної організації сховищ та ПРУнa розрахунковий строк у багатоквартирній житловій забудові'], ['safe_areas', 'Безпечні райони'], ['settlement', 'Населені пункти'], ['shore_zones', 'Берегові смуги водних шляхів'], ['slope', 'Ухили земної поверхні'], ['spec_landuse_zones', 'Зона особливого режиму використання земель'], ['starostynstvo', 'Території старостинських округів'], ['state_reg_interest', 'Території державних та регіональних інтересів'], ['strong_destructions_zones', 'Зони можливих сильних руйнувань'], ['sublease', 'Право суборенди'], ['suburban_zones', 'Приміські зони'], ['support_areas', 'Території, розвиток яких потребує державної підтримки'], ['techno_load', 'Техногенне навантаження'], ['trans_cor_infl_zones', 'Смуги впливу транспортних коридорів'], ['underground_spaces', 'Зони формування підземного простору'], ['unesco_nature_pg', "Території природних об'єктів всесвітньої спадщини ЮНЕСКО"], ['urban_dev_zones', 'Території за ступенем містобудівної цінності'], ['view_zones', 'Зони формування видів'], ['water_supply_protect_zones', 'Зони санітарної охорони джерел водопостачання'], ['waterb', 'Водойми'], ['watershed', 'Водозбірні басейни'], ['weak_destructions_zones', 'Зони можливих слабких руйнувань']]

def get_real_layer_name(layer: QgsVectorLayer) -> str:
    """
    Отримує назву реального шару, присутнього у QGIS.

    Аргументи:
        layer (QgsVectorLayer): Шар, з якого отримати назву.

    Повертає:
        str: Назва реального шару.
    """
    if not isinstance(layer, QgsVectorLayer):
        return None
    
    if layer.providerType() == "postgres":
        uri = layer.dataProvider().uri()
        source_layer_name = uri.table()
        source_layer_name = source_layer_name.strip("''")
    elif layer.providerType() == "ogr":
        uri_components = QgsProviderRegistry.instance().decodeUri(layer.dataProvider().name(), layer.dataProvider().dataSourceUri())
        if uri_components["layerName"]:
            source_layer_name = uri_components["layerName"]
        else:
            directory, filename_with_extension = os.path.split(uri_components["path"])
            source_layer_name, extension = os.path.splitext(filename_with_extension)
    else:
        source_layer_name = ''
        
    return source_layer_name

def sort_layers(only_selected = True):
    nodeTree = {}
    groups_indexes = []
    def get_node_dict_index(node: QgsLayerTreeNode) -> int:
        if not isinstance(node, QgsLayerTreeNode):
            return None
        if len(groups_indexes) == 0:
            groups_indexes.append(node)
            return 0
        
        for index, group in enumerate(groups_indexes):
            if groups_indexes[index] == node:
                return index
        
        groups_indexes.append(node)
        return len(groups_indexes)-1

    layer_tree_view:QgsLayerTreeView = iface.layerTreeView()
    
    if not only_selected:
        model = layer_tree_view.layerTreeModel()
        root = model.rootGroup()
        nodes = root.children()        
    else:        
        nodes = layer_tree_view.selectedNodes()

    def add_all_children(node):
        if node.nodeType() == 0:
            nodes.extend(node.children())
            for child in node.children():
                add_all_children(child)

    for node in nodes:
        add_all_children(node)


    for node in nodes:
        if node.nodeType() != 0:
            parent_node = node.parent()
            parent_name = parent_node.name()
            parent_index = get_node_dict_index(parent_node)
            if parent_index not in nodeTree:
                nodeTree[parent_index] = []
            nodeTree[parent_index].append(node)


    for parent_index, nodes in nodeTree.items():
        parent_group_node: QgsLayerTreeNode = groups_indexes[parent_index]
        for layer in reversed(layers_order):
            for node in nodes:            
                indx = layer_tree_view.node2index(node)
                layer_obj = layer_tree_view.layerForIndex(indx)
                layer_name = get_real_layer_name(layer_obj)
                if layer_name == layer[0]:
                    cloned_node: QgsLayerTreeNode = node.clone()
                    cloned_node.setName(layer[1])
                    parent_group_node.insertChildNode(0, cloned_node)
                    parent_group_node.removeChildNode(node)
                    nodeTree[parent_index].remove(node)
